<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>–¢–∞–ø–∞–ª–∫–∞ ‚Äî Telegram WebApp</title>
  <style>
    :root{
      --bg:#0f1217; --card:#171b22; --text:#e6edf3; --muted:#a0aec0;
      --accent:#6ee7ff; --accent2:#6fff9e; --danger:#ff6e6e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:16px; background:var(--bg); color:var(--text);
      font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial;
      -webkit-tap-highlight-color: transparent;
    }
    .app{max-width:720px; margin:0 auto; display:flex; flex-direction:column; gap:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.03), transparent 80%), var(--card);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:20px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    .stat{
      display:flex; flex-direction:column; padding:10px 12px; border-radius:14px;
      background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); min-width:120px
    }
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-weight:800; font-size:20px; margin-top:2px}

    .tap-wrap{display:grid; place-items:center; padding:4px 0 8px}
    .tap-btn{
      width:260px; height:260px; border-radius:50%;
      border:none; outline:none; cursor:pointer;
      color:#0a0f14; font-weight:900; font-size:28px; letter-spacing:0.5px;
      background:
        radial-gradient(120px 120px at 30% 30%, rgba(255,255,255,0.55), rgba(255,255,255,0) 60%),
        conic-gradient(from 0deg, #6ee7ff, #6fff9e, #ffe66e, #ff9e6e, #6ee7ff);
      box-shadow:
        0 10px 20px rgba(0,0,0,.35),
        inset 0 6px 18px rgba(255,255,255,.35),
        inset 0 -12px 24px rgba(0,0,0,.45);
      position:relative;
      transition: transform .06s ease, filter .2s ease;
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
    }
    .tap-btn::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      background: radial-gradient(120px 120px at 70% 30%, rgba(255,255,255,.3), rgba(255,255,255,0) 60%);
      filter:blur(1px);
      pointer-events:none; /* –≤–∞–∂–Ω–æ ‚Äî –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */
    }
    .tap-btn:active{ transform: scale(0.97); filter:saturate(1.2) }
    .tap-label{
      position:absolute; inset:0; display:grid; place-items:center; text-align:center;
      text-shadow: 0 2px 6px rgba(255,255,255,.35);
      padding:0 10px;
      pointer-events:none; /* –≤–∞–∂–Ω–æ ‚Äî –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{font-size:12px; color:var(--muted); padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}

    .shop{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:12px; align-items:center; padding:12px; border-radius:14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06)}
    .item .icon{font-size:20px}
    .item .title{font-weight:700}
    .item .desc{font-size:12px; color:var(--muted)}
    .item .price{font-weight:800}
    .btn-buy{
      margin-left:auto; padding:8px 12px; border-radius:10px; border:none; font-weight:800; cursor:pointer;
      color:#0a0f14; background:linear-gradient(180deg, #9dffb7, #6fff9e 60%, #41e57b);
      box-shadow: 0 6px 14px rgba(65,229,123,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }
    .btn-buy:disabled{ filter:grayscale(1) brightness(.8); cursor:not-allowed }

    .footer{display:flex; gap:10px; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px}
    .link{color:var(--accent); text-decoration:none}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.7); color:#fff; padding:10px 14px; border-radius:12px; font-size:14px;
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

    .pulse{
      position:absolute; inset:-8px; border-radius:50%; border:2px solid rgba(255,255,255,.25);
      animation:pulse 1.8s infinite ease-out;
      pointer-events:none; /* –≤–∞–∂–Ω–æ ‚Äî –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */
    }
    @keyframes pulse { 0% { opacity: .9; transform:scale(1) } 100% { opacity: 0; transform:scale(1.15) } }

    .float{
      position:fixed; left:0; top:0; transform:translate(-50%, -50%);
      font-weight:800; pointer-events:none; opacity:0;
      transition:transform .6s ease, opacity .6s ease;
      color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.6);
    }
    .float.show{opacity:1; transform:translate(-50%, -120%)}
  </style>
</head>
<body>
  <div class="app">
    <div class="card row">
      <div class="stat"><div class="label">–ë–∞–ª–∞–Ω—Å</div><div class="value" id="balance">0</div></div>
      <div class="stat"><div class="label">–ó–∞ —Ç–∞–ø</div><div class="value" id="perTap">+1</div></div>
      <div class="stat"><div class="label">AFK / —Å–µ–∫</div><div class="value" id="cps">0</div></div>
      <div class="grow"></div>
      <button id="btnSave" class="btn-buy" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–µ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="card tap-wrap">
      <button class="tap-btn" id="tapBtn" aria-label="Tap button">
        <div class="pulse"></div>
        <div class="tap-label"><div>–¢–∞–ø–Ω–∏!</div><div id="tapDelta" style="font-size:14px;opacity:.8;margin-top:6px">+1</div></div>
      </button>
      <div class="chips" style="margin-top:14px">
        <div class="chip" id="owner"></div>
        <div class="chip">–ù–µ—Ç –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –∫–ª–∏–∫–∏</div>
        <div class="chip">–û—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥</div>
        <div class="chip">–ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π</div>
      </div>
    </div>

    <div class="card">
      <div class="shop" id="shop"></div>
    </div>

    <div class="footer">
      <div>–í—ã–π–¥–µ—à—å ‚Äî —Ñ–∞—Ä–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>
      <a class="link" href="#" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <script>
    // Telegram WebApp –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg){ try{ tg.expand(); tg.setHeaderColor("#0f1217"); tg.setBackgroundColor("#0f1217"); }catch(_){} }

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    const defaultState = () => ({
      userId: (tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0) || 0,
      balance: 0, perTap: 1, cps: 0,
      upgrades: { tapPower: 0, autoClick: 0, multiplier: 0, offlineBonus: 0 },
      lastTs: Date.now()
    });
    const STATE_KEY = "tapper_state_v2";

    let state = loadState();
    applyOfflineIncome(); // —É—á—Ç—ë–º –æ—Ñ–ª–∞–π–Ω-—Ñ–∞—Ä–º —Å—Ä–∞–∑—É

    function loadState(){
      try{
        const raw = localStorage.getItem(STATE_KEY);
        if (!raw) return defaultState();
        const st = JSON.parse(raw);
        const uid = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
        if (uid && st.userId && st.userId !== uid) return defaultState();
        return st;
      }catch(e){ return defaultState(); }
    }
    function saveState(){
      try{
        state.lastTs = Date.now();
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      }catch(e){ /* ignore quota */ }
      updateUI();
    }
    function applyOfflineIncome(){
      const now = Date.now();
      const dt = Math.max(0, (now - (state.lastTs || now))/1000);
      const boost = 1 + state.upgrades.offlineBonus * 0.15;
      const earned = state.cps * dt * boost;
      if (earned > 0) state.balance += Math.floor(earned);
      state.lastTs = now;
    }

    // –ê–ø–≥—Ä–µ–π–¥—ã
    const shopItems = [
      { id:"tapPower", icon:"üëÜ", title:"–°–∏–ª–∞ —Ç–∞–ø–∞", desc:"–ö–∞–∂–¥—ã–π —Ç–∞–ø –¥–∞—ë—Ç –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç.",
        price:l=>Math.floor(25*Math.pow(1.35,l)),
        buy:()=>{ state.upgrades.tapPower++; state.perTap = 1 + state.upgrades.tapPower * 1; } },
      { id:"autoClick", icon:"ü§ñ", title:"–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä", desc:"–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É.",
        price:l=>Math.floor(100*Math.pow(1.4,l)),
        buy:()=>{ state.upgrades.autoClick++; state.cps = baseCps(); } },
      { id:"multiplier", icon:"‚ú®", title:"–ú–Ω–æ–∂–∏—Ç–µ–ª—å", desc:"–£–º–Ω–æ–∂–∞–µ—Ç –¥–æ—Ö–æ–¥ –æ—Ç —Ç–∞–ø–∞ –∏ AFK.",
        price:l=>Math.floor(250*Math.pow(1.55,l)),
        buy:()=>{ state.upgrades.multiplier++; state.cps = baseCps(); } },
      { id:"offlineBonus", icon:"üåô", title:"–û—Ñ–ª–∞–π–Ω-—Ñ–∞—Ä–º", desc:"–ü–æ–≤—ã—à–∞–µ—Ç –¥–æ—Ö–æ–¥ –≤ –æ—Ñ–ª–∞–π–Ω–µ.",
        price:l=>Math.floor(300*Math.pow(1.5,l)),
        buy:()=>{ state.upgrades.offlineBonus++; } }
    ];
    function baseCps(){
      const m = 1 + state.upgrades.multiplier * 0.10;
      return Math.floor(state.upgrades.autoClick * m);
    }
    function perTapWithMult(){
      const m = 1 + state.upgrades.multiplier * 0.15;
      return Math.max(1, Math.floor(state.perTap * m));
    }

    // –°—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
    const $ = s => document.querySelector(s);
    const elBalance=$("#balance"), elPerTap=$("#perTap"), elCps=$("#cps"), elTapBtn=$("#tapBtn"),
          elTapDelta=$("#tapDelta"), elShop=$("#shop"), elOwner=$("#owner"),
          elToast=$("#toast"), elSaveBtn=$("#btnSave"), elReset=$("#btnReset");

    function updateUI(){
      elBalance.textContent = format(state.balance);
      elPerTap.textContent  = "+" + format(perTapWithMult());
      elCps.textContent     = format(state.cps);
      elTapDelta.textContent= "+" + format(perTapWithMult());
      renderShop();
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
        const u = tg.initDataUnsafe.user;
        elOwner.textContent = `–ò–≥—Ä–æ–∫: ${u.first_name||""} ${u.last_name||""}`.trim();
      } else { elOwner.textContent = "–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫"; }
    }

    function renderShop(){
      elShop.innerHTML = "";
      shopItems.forEach(item => {
        const lvl = state.upgrades[item.id] || 0;
        const cost = item.price(lvl);
        const can = state.balance >= cost;

        const row = document.createElement("div");
        row.className="item";
        row.innerHTML = `
          <div class="icon">${item.icon}</div>
          <div class="grow">
            <div class="title">${item.title} <span style="color:var(--muted);font-weight:600">—É—Ä. ${lvl}</span></div>
            <div class="desc">${item.desc}</div>
          </div>
          <div class="price" style="margin-right:8px">${format(cost)}</div>
        `;

        const btn=document.createElement("button");
        btn.className="btn-buy"; btn.textContent="–ö—É–ø–∏—Ç—å"; btn.disabled=!can;
        btn.addEventListener("click", () => {
          const curLvl = state.upgrades[item.id] || 0;
          const priceNow = item.price(curLvl);
          if (state.balance >= priceNow){
            state.balance -= priceNow;
            item.buy();
            state.cps = baseCps();
            saveState();
            toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.title} (—É—Ä. ${state.upgrades[item.id]})`);
          } else {
            toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç");
          }
        });
        row.appendChild(btn);
        elShop.appendChild(row);
      });
    }

    // –¢–∞–ø ‚Äî –Ω–∞–¥—ë–∂–Ω–æ –¥–ª—è Telegram webview
    function onTap(ev){
      const gain = perTapWithMult();
      state.balance += gain;

      // –º–∏–Ω–∏-–∞–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
      elTapBtn.style.transform = "scale(0.97)";
      setTimeout(()=> elTapBtn.style.transform = "", 80);

      // –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π +X —É —Ç–æ—á–∫–∏ —Ç–∞–ø–∞ (–µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –µ—Å—Ç—å)
      const x = (ev && ev.clientX) ? ev.clientX : (window.innerWidth/2);
      const y = (ev && ev.clientY) ? ev.clientY : (window.innerHeight/2);
      spawnFloat("+"+format(gain), x, y);

      saveState();
    }
    elTapBtn.addEventListener("pointerdown", onTap); // –≥–ª–∞–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –º–æ–±–∏–ª–µ
    elTapBtn.addEventListener("click", onTap);       // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

    // AFK-—Ü–∏–∫–ª
    setInterval(() => {
      if (state.cps > 0){
        state.balance += state.cps;
        saveState();
      }
    }, 1000);

    // –ü–µ—Ä–µ–∑–∞—Ö–æ–¥ ‚Äî –¥–æ–Ω–∞—á–∏—Å–ª–∏—Ç—å –æ—Ñ–ª–∞–π–Ω
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible"){
        applyOfflineIncome(); saveState();
      }
    });

    // –£—Ç–∏–ª–∏—Ç—ã
    function format(n){
      if (n < 1000) return ""+n;
      const units = ["","K","M","B","T","Q"];
      let u=0, num=n;
      while (num >= 1000 && u < units.length-1){ num/=1000; u++; }
      return (num < 10 ? num.toFixed(2) : num.toFixed(1)) + units[u];
    }
    function toast(text){
      elToast.textContent = text;
      elToast.classList.add("show");
      setTimeout(()=> elToast.classList.remove("show"), 1500);
    }
    function spawnFloat(text, x, y){
      const el = document.createElement("div");
      el.className="float"; el.textContent=text;
      el.style.left = x+"px"; el.style.top = y+"px";
      document.body.appendChild(el);
      requestAnimationFrame(()=> el.classList.add("show"));
      setTimeout(()=> el.remove(), 650);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–æ—Ç–∞
    elSaveBtn.addEventListener("click", () => {
      try{
        if (tg && tg.sendData){
          tg.sendData(JSON.stringify({type:"sync", state}));
          toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É");
        } else {
          toast("–ù–µ—Ç Telegram WebApp –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞");
        }
      }catch(e){ toast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
    });

    // –°–±—Ä–æ—Å
    elReset.addEventListener("click", (e) => {
      e.preventDefault();
      if (typeof confirm === "function"){
        if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) return;
      }
      state = defaultState(); saveState(); toast("–°–±—Ä–æ—à–µ–Ω–æ");
    });

    // –°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    updateUI();
  </script>
</body>
</html>
