<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>TG WebApp — tapper (with context debug)</title>
  <!-- ВАЖНО: официальный скрипт Telegram Web Apps -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0f1217;color:#e6edf3;font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    .app{max-width:720px;margin:0 auto;padding:16px;display:flex;gap:12px;flex-direction:column}
    .card{background:#171b22;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;min-width:120px}
    .label{font-size:12px;color:#a0aec0}
    .value{font-weight:800;font-size:20px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;color:#0a0f14;background:#6fff9e}
    .tap{width:240px;height:240px;border-radius:50%;border:none;cursor:pointer;font-weight:900;font-size:28px;background:conic-gradient(#6ee7ff,#6fff9e,#ffe66e,#ff9e6e,#6ee7ff)}
    .muted{color:#a0aec0;font-size:12px}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;background:#0b0e13;padding:10px;border-radius:10px;display:block;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="row">
        <div class="stat"><div class="label">Баланс</div><div class="value" id="balance">0</div></div>
        <div class="stat"><div class="label">За тап</div><div class="value" id="perTap">+1</div></div>
        <div style="margin-left:auto"></div>
        <button class="btn" id="save">Сохранить</button>
      </div>
    </div>

    <div class="card" style="display:grid;place-items:center">
      <button class="tap" id="tap">Тапни!</button>
      <div class="muted" id="owner" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="label">Статус Telegram WebApp контекста:</div>
      <code id="ctx">—</code>
    </div>
  </div>

  <script>
    // ЯВНО ждём готовности Telegram.WebApp
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      try { tg.ready(); tg.expand(); } catch(e) {}
    }

    const elBal = document.getElementById('balance');
    const elTap = document.getElementById('tap');
    const elSave = document.getElementById('save');
    const elCtx = document.getElementById('ctx');
    const elOwner = document.getElementById('owner');

    let balance = 0;

    function stringify(obj) {
      try { return JSON.stringify(obj, null, 2); } catch(e) { return String(obj); }
    }

    function updateStatus(){
      const hasSend = !!(tg && typeof tg.sendData === 'function');
      const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
      elOwner.textContent = hasSend
        ? `WebApp v${tg.version} · ${tg.platform} · user#${user ? user.id : "?"}`
        : "Нет WebApp контекста";
      elCtx.textContent = stringify({
        hasTelegramObject: !!window.Telegram,
        hasWebApp: !!tg,
        hasSendData: hasSend,
        version: tg ? tg.version : null,
        platform: tg ? tg.platform : null,
        initData: tg ? (tg.initData ? "[present]" : null) : null,
        initDataUnsafe: tg ? (tg.initDataUnsafe ? { user_id: tg.initDataUnsafe.user && tg.initDataUnsafe.user.id } : null) : null,
        locationHref: location.href
      });
    }
    updateStatus();

    elTap.addEventListener('click', () => {
      balance += 1;
      elBal.textContent = balance;
    });

    elSave.addEventListener('click', () => {
      updateStatus();
      if (!(tg && typeof tg.sendData === 'function')) {
        alert('Нет Telegram WebApp контекста — открой через кнопку WebApp в ЛИЧНОМ чате.');
        return;
      }
      try {
        tg.sendData(JSON.stringify({ type: 'sync', state: { balance } }));
        alert('Отправлено боту');
      } catch (e) {
        alert('Ошибка tg.sendData: ' + e);
      }
    });
  </script>
</body>
</html>
