<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eternal Tapper — WebApp</title>
  <style>
    :root{--bg:#0b0f14;--card:#121a24;--muted:#7c8aa2;--text:#ebf0f7;--acc:#2dd4bf;--danger:#ff6b6b}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b0f14,#0d121a);color:var(--text);}
    .wrap{max-width:760px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid #1c2633;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:18px}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="url"],input[type="text"]{flex:1;min-width:260px;padding:12px 14px;border-radius:12px;border:1px solid #233042;background:#0e1520;color:var(--text)}
    button{padding:12px 14px;border-radius:12px;border:1px solid #233042;background:#121f2e;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1f877b,#1b6a61);border-color:#1e8f83}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .kv{background:#0d1622;border:1px solid #1d2a3b;border-radius:12px;padding:12px}
    .kv b{display:block;font-size:13px;color:#9bb7d0;margin-bottom:6px}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0c141f;border:1px solid #1d2a3b;border-radius:12px;padding:12px 14px;display:none;z-index:1000}
    a{color:var(--acc)} a:hover{text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>⚡ Eternal Tapper — WebApp</h1>
      <div class="row" id="profPanel">
        <input id="profInput" type="url" placeholder="Вставь ссылку профиля ReManga (https://remanga.org/user/2384260/about)" />
        <button id="btnBind" class="primary">Привязать</button>
      </div>
      <div class="muted" style="margin-top:8px">Можно просто ID (например, <code>40277</code>). Форматы <code>/user/…</code>, <code>/users/…</code>, с параметрами — тоже ок.</div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="row">
        <button id="btnSync" class="primary">⚡ Синхр. энергию</button>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="kv"><b>Профиль</b><div id="kvProfile" class="muted">не привязан</div></div>
        <div class="kv"><b>Энергия</b><div id="kvEnergy">0</div></div>
        <div class="kv"><b>Начислено</b><div id="kvClaimed">0</div></div>
        <div class="kv"><b>Последний diff</b><div id="kvLastDiff" class="muted">—</div></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="muted">
        Источники данных:<br>
        <code>history_ew.json</code> · <code>history_ed.json</code>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
// ====== КОНФИГ ======
const ENERGY_SOURCES = [
  "./history_ew.json",   // Eternal Warriors
  "./history_ed.json",   // Eternal Demonic
];

const withBust = (u) => `${u}${u.includes('?') ? '&' : '?'}t=${Date.now()}`;

// ====== УТИЛИТЫ ======
function $(id){ return document.getElementById(id); }
const elProfPanel = $("profPanel");
const elProfInput = $("profInput");
const elBind      = $("btnBind");
const elSync      = $("btnSync");
const elKvProf    = $("kvProfile");
const elKvEnergy  = $("kvEnergy");
const elKvClaimed = $("kvClaimed");
const elKvDiff    = $("kvLastDiff");
const elToast     = $("toast");

function toast(msg, ms=2200){
  elToast.textContent = msg;
  elToast.style.display = 'block';
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=>{ elToast.style.display='none'; }, ms);
}

function parseQuery(){
  const p = new URLSearchParams(location.search);
  const o = {}; for (const [k,v] of p) o[k]=v; return o;
}

function normalizeProfile(input){
  if (input == null) return null;
  if (typeof input === 'number') return `https://remanga.org/user/${input}/about`;
  let s = String(input).trim();
  if (!s) return null;
  if (/^\d+$/.test(s)) return `https://remanga.org/user/${s}/about`;
  if (s.startsWith('/')) s = 'https://remanga.org' + s;
  if (/^(?:www\.)?remanga\.org\b/i.test(s)) s = 'https://' + s.replace(/^https?:\/\//i,'');
  try{
    const u = new URL(s);
    const host = u.hostname.toLowerCase();
    if (host !== 'remanga.org' && host !== 'www.remanga.org') return null;
    const path = u.pathname.replace(/^\/+|\/+$|/g,'');
    const m = path.match(/^(?:user|users)\/(\d+)(?:\/.*)?$/i);
    if (!m) return null;
    return `https://remanga.org/user/${parseInt(m[1],10)}/about`;
  }catch{ return null; }
}

async function fetchJson(url, timeoutMs=10000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(withBust(url), {signal: ctrl.signal, cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  } finally { clearTimeout(t); }
}

function readState(){
  try{ return JSON.parse(localStorage.getItem('eternal_state')||'{}'); }
  catch{ return {}; }
}
function writeState(s){ localStorage.setItem('eternal_state', JSON.stringify(s)); }

const S = Object.assign({
  profile:null,
  energy:0,
  claimedEnergy:0,
  lastDiff:null,
}, readState());

function updateUI(){
  elKvProf.innerHTML = S.profile ? `<a href="${S.profile}" target="_blank">${S.profile}</a>` : 'не привязан';
  elKvEnergy.textContent  = String(S.energy||0);
  elKvClaimed.textContent = String(S.claimedEnergy||0);
  elKvDiff.textContent    = S.lastDiff==null? '—' : String(S.lastDiff);
}

function setProfile(raw){
  const canon = normalizeProfile(raw);
  if (!canon){ toast('Ссылка/ID не распознаны'); return; }
  S.profile = canon; writeState(S); updateUI(); toast('Профиль привязан');
}

async function bindFromInput(){ setProfile(elProfInput.value); }

async function syncEnergy(){
  if (!S.profile){ toast('Сначала привяжи профиль'); elProfPanel.style.display=''; elProfInput.focus(); return; }
  elSync.disabled = true;
  try{
    const parts = await Promise.allSettled(ENERGY_SOURCES.map(src => fetchJson(src).catch(()=>[])));
    let all = [];
    for (const p of parts){ if (p.status==='fulfilled' && Array.isArray(p.value)) all = all.concat(p.value); }

    const norm = normalizeProfile(S.profile);
    const found = all.find(row => normalizeProfile(row && (row.profile||row.profile_url||row.url||row.link)) === norm);

    if (!found){ toast('Профиль не найден в данных'); return; }

    const diff = Number(found.diff||0) || 0;
    S.lastDiff = diff;
    const totalEarnable = Math.floor(diff / 300);
    const delta = Math.max(0, totalEarnable - (S.claimedEnergy||0));
    if (delta>0){
      S.energy += delta;
      S.claimedEnergy += delta;
      writeState(S); updateUI();
      toast(`Начислено ⚡${delta} (diff: ${diff})`);
    } else {
      updateUI(); toast(`Нет новой энергии (diff: ${diff})`);
    }
  } catch(e){
    console.error(e); toast('Ошибка синхронизации');
  } finally {
    elSync.disabled = false;
  }
}

// ====== ИНИТ ======
elBind.addEventListener('click', bindFromInput);
elSync.addEventListener('click', syncEnergy);

(() => {
  const q = parseQuery();
  if (q.profile){
    const canon = normalizeProfile(q.profile);
    if (canon){ S.profile = canon; writeState(S); }
  }
  updateUI();
})();
</script>
</body>
</html>
