<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>–ïternal Tap ‚Äî Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0d1116; --surface:#121720; --card:#151a23; --ghost:#0a0f16;
      --text:#e6edf3; --muted:#9aa6b2;
      --stroke:#232a36; --stroke2:#1d2430;
      --green:#6fff9e; --green-2:#44e784;
      --grey-btn-top:#c7c9cd; --grey-btn-mid:#b7bac0; --grey-btn-btm:#a0a6ae;
      --shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 40% -100px, rgba(102,153,255,.08), transparent 60%), var(--bg);
      color:var(--text); font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px; margin:0 auto; padding:18px; display:flex; flex-direction:column; gap:14px}
    /* Top Stats */
    .top{display:flex; gap:14px; align-items:stretch; flex-wrap:wrap}
    .kpi{
      min-width:160px; flex:1; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 80%), var(--card);
      border:1px solid var(--stroke); border-radius:16px; padding:12px 14px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; justify-content:center; gap:6px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-weight:900; font-size:22px}
    .save{
      padding:0 18px; background:radial-gradient(80% 120% at 20% 20%, rgba(255,255,255,.28), transparent 40%),
                  linear-gradient(180deg, var(--green), var(--green-2) 60%, #26c068);
      color:#06120b; border:none; border-radius:14px; font-weight:900; font-size:16px; cursor:pointer;
      box-shadow: 0 12px 30px rgba(111,255,158,.25), inset 0 2px 0 rgba(255,255,255,.45);
      transition: transform .06s ease, filter .2s ease;
      min-height:56px;
    }
    .save:active{ transform: translateY(1px) scale(.99); filter:saturate(1.05) }
    .save:disabled{ filter:grayscale(.5) brightness(.9); cursor:not-allowed }

    /* Panel with big circle */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 80%), var(--surface);
      border:1px solid var(--stroke); border-radius:18px; padding:16px; box-shadow:var(--shadow);}
    .panel-inner{display:grid; place-items:center; padding:6px 4px 12px}
    .tap{
      width:340px; height:340px; border-radius:50%; border:none; cursor:pointer;
      color:#071013; position:relative; font-weight:900; font-size:42px; letter-spacing:.4px;
      background:
        radial-gradient(150px 150px at 30% 25%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
        conic-gradient(from 0deg, #6ee7ff, #6fff9e, #ffe66e, #ff996e, #6ee7ff);
      box-shadow:
        0 24px 36px rgba(0,0,0,.35),
        inset 0 14px 32px rgba(255,255,255,.35),
        inset 0 -18px 36px rgba(0,0,0,.50);
      transition: transform .06s ease;
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
    }
    .tap:active{ transform: scale(.985) }
    .tap .sub{ position:absolute; left:0; right:0; bottom:34%; text-align:center; font-size:18px; opacity:.9 }
    .chips{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding:12px 4px 4px}
    .chip{
      font-size:12px; color:var(--muted); padding:8px 12px; border-radius:999px;
      background:#151a23; border:1px solid var(--stroke);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    /* Shop */
    .shop{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 80%), var(--surface);
      border:1px solid var(--stroke); border-radius:18px; padding:14px; box-shadow:var(--shadow);}
    .shop-title{font-weight:900; font-size:18px; margin:6px 4px 10px; color:#dce4ea}
    .item{display:flex; gap:14px; align-items:center; padding:14px; margin:8px 0;
      border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 80%), var(--card);
      border:1px solid var(--stroke2); box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    .icon{font-size:22px}
    .grow{flex:1}
    .title{font-weight:800}
    .desc{font-size:12px; color:var(--muted); margin-top:3px}
    .price{font-weight:900; min-width:72px; text-align:right; color:#d8dee6}
    .buy{
      min-width:120px; padding:10px 14px; border-radius:12px; border:none; font-weight:900; cursor:pointer; color:#101419;
      background:linear-gradient(180deg, var(--grey-btn-top), var(--grey-btn-mid) 55%, var(--grey-btn-btm));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.65), 0 6px 14px rgba(0,0,0,.25);
    }
    .buy:disabled{ filter:grayscale(.8) brightness(.9); cursor:not-allowed }
    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.75); color:#fff; padding:10px 14px; border-radius:12px; font-size:14px;
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    /* Floating +N */
    .float{
      position:fixed; left:0; top:0; transform:translate(-50%,-50%);
      color:#fff; font-weight:900; text-shadow:0 2px 6px rgba(0,0,0,.6);
      pointer-events:none; opacity:0; transition:transform .6s ease, opacity .6s ease;
    }
    .float.show{ opacity:1; transform:translate(-50%,-120%) }
    @media (max-width:560px){
      .tap{ width:280px; height:280px; font-size:36px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="top">
      <div class="kpi"><div class="label">–ë–∞–ª–∞–Ω—Å</div><div class="value" id="balance">0</div></div>
      <div class="kpi"><div class="label">–ó–∞ —Ç–∞–ø</div><div class="value" id="perTap">+1</div></div>
      <div class="kpi"><div class="label">AFK / —Å–µ–∫</div><div class="value" id="cps">0</div></div>
      <button class="save" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- Big circle -->
    <div class="panel">
      <div class="panel-inner">
        <button class="tap" id="tapBtn">–¢–∞–ø–Ω–∏!<div class="sub" id="tapDelta">+1</div></button>
        <div class="chips">
          <div class="chip" id="userChip">–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫</div>
          <div class="chip" id="unameChip"></div>
          <div class="chip">–û—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥</div>
          <div class="chip"><a href="#shop" style="text-decoration:none;color:inherit">–ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π</a></div>
        </div>
      </div>
    </div>

    <!-- Shop -->
    <div class="shop" id="shop">
      <div class="shop-title">–£–ª—É—á—à–µ–Ω–∏—è</div>
      <div id="shopList"></div>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <script>
    // Telegram context
    const tg = window.Telegram?.WebApp;
    if (tg){ try{ tg.ready(); tg.expand(); tg.setBackgroundColor('#0d1116'); tg.setHeaderColor('#0d1116'); }catch(e){} }

    // CloudStorage (may be unsupported in some clients)
    const cloud = tg?.CloudStorage;
    const CLOUD_KEY = "tapper_state_v3";
    const STATE_KEY = "tapper_state_v3";

    // State
    const def = () => ({
      userId: tg?.initDataUnsafe?.user?.id || 0,
      balance: 0,
      upgrades: { tapPower:0, autoClick:0, mult:0, offline:0 },
      baseTap: 1,
      lastTs: Date.now()
    });
    let S = def();

    // Elements
    const $ = s => document.querySelector(s);
    const elBal = $("#balance"), elPerTap=$("#perTap"), elCps=$("#cps"),
          elTap=$("#tapBtn"), elDelta=$("#tapDelta"), elToast=$("#toast"),
          elSave=$("#btnSave"), elShop=$("#shopList"), elUser=$("#userChip"), elUname=$("#unameChip");

    // Numbers
    const fmt = n => (n<1000? n.toString() : (n<1e6? (n/1e3).toFixed(1)+'K' : (n/1e6).toFixed(2)+'M'));

    // Derived
    const perTap = () => Math.max(1, Math.floor((S.baseTap + S.upgrades.tapPower) * (1 + 0.15*S.upgrades.mult)));
    const cps = () => Math.floor((S.upgrades.autoClick) * (1 + 0.10*S.upgrades.mult));
    const offlineBoost = () => 1 + 0.15*S.upgrades.offline;

    // UI
    function updateUI(){
      elBal.textContent = fmt(S.balance);
      elPerTap.textContent = "+" + fmt(perTap());
      elCps.textContent = fmt(cps());
      elDelta.textContent = "+" + fmt(perTap());

      const u = tg?.initDataUnsafe?.user;
      if (u){
        elUser.textContent = `${u.first_name||''} ${u.last_name||''}`.trim() || ("user#" + u.id);
        elUname.textContent = u.username? "@"+u.username : `user#${u.id}`;
      } else {
        elUser.textContent = "–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫";
        elUname.textContent = "";
      }

      renderShop();
    }

    // Shop
    const ITEMS = [
      { id:"tapPower", icon:"üëÜ", title:"–°–∏–ª–∞ —Ç–∞–ø–∞", desc:"–ö–∞–∂–¥—ã–π —Ç–∞–ø –¥–∞—ë—Ç –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç.",
        price:l=>Math.floor(25*Math.pow(1.35,l)), buy:()=>{ S.upgrades.tapPower++; } },
      { id:"autoClick", icon:"ü§ñ", title:"–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä", desc:"–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É.",
        price:l=>Math.floor(100*Math.pow(1.40,l)), buy:()=>{ S.upgrades.autoClick++; } },
      { id:"mult", icon:"‚ú®", title:"–ú–Ω–æ–∂–∏—Ç–µ–ª—å", desc:"–£–º–Ω–æ–∂–∞–µ—Ç –¥–æ—Ö–æ–¥ –æ—Ç —Ç–∞–ø–∞ –∏ AFK.",
        price:l=>Math.floor(250*Math.pow(1.55,l)), buy:()=>{ S.upgrades.mult++; } },
      { id:"offline", icon:"üåô", title:"–û—Ñ–ª–∞–π–Ω-—Ñ–∞—Ä–º", desc:"–ü–æ–≤—ã—à–∞–µ—Ç –¥–æ—Ö–æ–¥ –≤ –æ—Ñ–ª–∞–π–Ω–µ.",
        price:l=>Math.floor(300*Math.pow(1.50,l)), buy:()=>{ S.upgrades.offline++; } },
    ];

    function renderShop(){
      elShop.innerHTML = "";
      for (const it of ITEMS){
        const lvl = S.upgrades[it.id]||0;
        const cost = it.price(lvl);
        const can = S.balance >= cost;

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="icon">${it.icon}</div>
          <div class="grow">
            <div class="title">${it.title} <span style="color:var(--muted);font-weight:600">—É—Ä. ${lvl}</span></div>
            <div class="desc">${it.desc}</div>
          </div>
          <div class="price">${fmt(cost)}</div>
        `;
        const btn = document.createElement("button");
        btn.className = "buy";
        btn.textContent = "–ö—É–ø–∏—Ç—å";
        btn.disabled = !can;
        btn.onclick = () => {
          const lv = S.upgrades[it.id]||0;
          const priceNow = it.price(lv);
          if (S.balance >= priceNow){
            S.balance -= priceNow;
            it.buy();
            saveSoon();
            toast(`–ö—É–ø–ª–µ–Ω–æ: ${it.title} (—É—Ä. ${S.upgrades[it.id]})`);
            updateUI();
          }
        };
        row.appendChild(btn);
        elShop.appendChild(row);
      }
    }

    // Float +N
    function floatText(text, x, y){
      const el = document.createElement("div");
      el.className = "float";
      el.textContent = text;
      el.style.left = x+"px"; el.style.top = y+"px";
      document.body.appendChild(el);
      requestAnimationFrame(()=> el.classList.add("show"));
      setTimeout(()=> el.remove(), 650);
    }

    // Offline income
    function applyOffline(){
      const now = Date.now();
      const dt = Math.max(0, (now - (S.lastTs||now))/1000);
      const earn = Math.floor(cps()*dt*offlineBoost());
      if (earn>0) S.balance += earn;
      S.lastTs = now;
    }

    // Save logic
    function saveLocal(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(S)); }catch(e){} }
    async function cloudSet(key,val){ return new Promise(r=>{ if(!cloud) return r(false); cloud.setItem(key,val, (err)=> r(!err)); }); }
    async function cloudGet(key){ return new Promise(r=>{ if(!cloud) return r(null); cloud.getItem(key, (err,v)=> r(err?null:v||null)); }); }

    let saveTimer=null;
    function saveSoon(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=> { persist(); }, 400);
    }
    async function persist(){
      S.lastTs = Date.now();
      saveLocal();
      if (cloud) await cloudSet(CLOUD_KEY, JSON.stringify(S));
    }

    // Tap
    elTap.addEventListener("pointerdown", (ev)=>{
      const gain = perTap();
      S.balance += gain;
      floatText("+"+fmt(gain), ev.clientX || innerWidth/2, ev.clientY || innerHeight/2);
      saveSoon();
      updateUI();
    });

    // AFK tick
    setInterval(()=>{
      const inc = cps();
      if (inc>0){ S.balance += inc; saveSoon(); updateUI(); }
    }, 1000);

    // Save button: cloud + backup to bot
    elSave.addEventListener("click", async ()=>{
      await persist();
      try{ if (tg && typeof tg.sendData==="function"){ tg.sendData(JSON.stringify({type:"sync", state:S})); } }catch(e){}
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    });

    // Toast helper
    function toast(t){ elToast.textContent = t; elToast.classList.add("show"); setTimeout(()=> elToast.classList.remove("show"), 1400); }

    // Init
    (async ()=>{
      // Cloud -> Local -> Default
      let loaded=null;
      const raw = await cloudGet(CLOUD_KEY);
      if (raw){ try{ loaded=JSON.parse(raw); }catch{} }
      if (!loaded){ try{ const r=localStorage.getItem(STATE_KEY); loaded=r?JSON.parse(r):null; }catch{} }
      S = Object.assign(def(), loaded||{});
      applyOffline();
      saveLocal();
      if (cloud) await cloudSet(CLOUD_KEY, JSON.stringify(S));
      updateUI();
    })();

    // Update chips with user
    const u = tg?.initDataUnsafe?.user;
    if (u){
      elUser.textContent = `${u.first_name||''} ${u.last_name||''}`.trim() || ("user#"+u.id);
      elUname.textContent = u.username? "@"+u.username : `user#${u.id}`;
    }
  </script>
</body>
</html>
